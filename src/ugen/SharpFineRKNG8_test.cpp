#include "SharpFineRKNG8.hpp"

#include "doctest/doctest.h"

#include <cstddef>

TEST_CASE("SharpFineRKNG8 simple first-order integration with closed form") {
    struct FirstOrderFunctor {
        double operator()(double x, double y, double yPrime) const {
            return 2.0;
        }
    };

    FirstOrderFunctor f;
    double h = 0.25;
    double x = 0.0;
    double y = 0.0;
    double yPrime = 0.0;
    double yNext, yPrimeNext, yHat, yHatPrime;

    for (auto i = 0; i < 2500; ++i) {
        egSC::SharpFineRKNG8<FirstOrderFunctor>(f, h, x, y, yPrime, yNext, yPrimeNext, yHat, yHatPrime);

        x += h;
        y = yNext;
        yPrime = yPrimeNext;

        CHECK(y == doctest::Approx(x * x));
        CHECK(yPrime == doctest::Approx(2.0 * x));
    }
}

// 3-tuples of data (x, y, y') of the van der Pol second-order nonlinear ODE
//  y'' - mu*(1 - y^2) * y' - y = 0
// With mu = 1 and initial conditions x = 0, y = 0, y' = 0 as computed by the MATLAB ode solver ode45 from the MATLAB
// documentation at https://www.mathworks.com/help/matlab/ref/ode45.html
static const double kVanDerPolTestData[] = {
    0.0000000000, 0.0000000000, 2.0000000000, 0.0000251189, -0.0000502358, 1.9999999994, 0.0000502377, -0.0001004679,
    1.9999999975, 0.0000753566, -0.0001506962, 1.9999999943, 0.0001004755, -0.0002009206, 1.9999999899, 0.0002260698,
    -0.0004519863, 1.9999999489, 0.0003516641, -0.0007029573,
    1.9999998764, 0.0004772584, -0.0009538338, 1.9999997723, 0.0006028527,
    -0.0012046158, 1.9999996368, 0.0012308244, -0.0024571089, 1.9999984869,
    0.0018587960, -0.0037072437, 1.9999965513, 0.0024867676, -0.0049550241,
    1.9999938313, 0.0031147392, -0.0062004542, 1.9999903286, 0.0062545972,
    -0.0123924873, 1.9999611237, 0.0093944553, -0.0185263558, 1.9999125681,
    0.0125343133, -0.0246025558, 1.9998448438, 0.0156741713, -0.0306215837,
    1.9997581309, 0.0313734615, -0.0598765217, 1.9990459563, 0.0470727517,
    -0.0877764945, 1.9978852116, 0.0627720419, -0.1143828251, 1.9962966670,
    0.0784713321, -0.1397561358, 1.9943001777, 0.1299531805, -0.2150479932,
    1.9851264157, 0.1814350289, -0.2797016078, 1.9723549870, 0.2329168773,
    -0.3354833245, 1.9564779061, 0.2843987256, -0.3839611232, 1.9379231097,
    0.3484736678, -0.4361486050, 1.9116185702, 0.4125486101, -0.4812727116,
    1.8822011010, 0.4766235523, -0.5210801207, 1.8500538551, 0.5406984945,
    -0.5570047752, 1.8154877047, 0.6252200204, -0.6003802932, 1.7665619221,
    0.7097415464, -0.6410344377, 1.7140916661, 0.7942630723, -0.6806061386,
    1.6582260604, 0.8787845983, -0.7204449518, 1.5990144513, 1.0098885668,
    -0.7854067563, 1.5003553959, 1.1409925352, -0.8574821540, 1.3927624700,
    1.2720965037, -0.9405609440, 1.2750455093, 1.4032004722, -1.0389875516,
    1.1454717525, 1.5250199232, -1.1484684313, 1.0124429848, 1.6468393743,
    -1.2804137734, 0.8647533411, 1.7686588253, -1.4398520576, 0.6993591097,
    1.8904782763, -1.6313594455, 0.5126405495, 2.0122977274, -1.8562889750,
    0.3008802192, 2.1341171784, -2.1119541731, 0.0592030866, 2.2559366295,
    -2.3745096657, -0.2145300798, 2.3777560805, -2.5907460373, -0.5175932884,
    2.4781898759, -2.6773808054, -0.7837801717, 2.5786236712, -2.6258940721,
    -1.0514577692, 2.6790574666, -2.4115902633, -1.3052066782, 2.7794912619,
    -2.0456016461, -1.5300205675, 2.8667416084, -1.6488306041, -1.6910980497,
    2.9539919549, -1.2340515978, -1.8166123325, 3.0412423014, -0.8415451655,
    -1.9071736358, 3.1284926479, -0.5055476121, -1.9657243236, 3.1986968891,
    -0.2861737463, -1.9933286825, 3.2689011303, -0.1048884336, -2.0068890078,
    3.3391053716, 0.0426199615, -2.0088555069, 3.4093096128, 0.1614738999,
    -2.0014844867, 3.4733998493, 0.2498499510, -1.9882430622, 3.5374900859,
    0.3230291545, -1.9698319210, 3.6015803225, 0.3842037160, -1.9470881687,
    3.6656705590, 0.4360502585, -1.9207343882, 3.7311249583, 0.4816866704,
    -1.8906752324, 3.7965793576, 0.5218013797, -1.8578139021, 3.8620337570,
    0.5578964549, -1.8224516554, 3.9274881563, 0.5912002775, -1.7848247853,
    4.0192073099, 0.6350190727, -1.7285834091, 4.1109264635, 0.6773677896,
    -1.6683989331, 4.2026456171, 0.7199609614, -1.6043169237, 4.2943647707,
    0.7642552225, -1.5362619532, 4.4460951695, 0.8447462677, -1.4143155580,
    4.5978255684, 0.9391020780, -1.2792110136, 4.7495559672, 1.0538548898,
    -1.1283381602, 4.9012863660, 1.1969639108, -0.9579803411, 5.0136026760,
    1.3264645040, -0.8165085779, 5.1259189859, 1.4811186601, -0.6590749105,
    5.2382352958, 1.6640903480, -0.4826916848, 5.3505516057, 1.8758271244,
    -0.2841787420, 5.4628679157, 2.1114239953, -0.0607124744, 5.5751842256,
    2.3528208719, 0.1902034845, 5.6875005355, 2.5613704725, 0.4669960815,
    5.7998168454, 2.6753256677, 0.7622166235, 5.9017342249, 2.6299757740,
    1.0348829037, 6.0036516043, 2.4210090473, 1.2940110288, 6.1055689837,
    2.0665606815, 1.5230365703, 6.2074863632, 1.6085027292, 1.7104019008,
    6.2902894007, 1.2140537920, 1.8268109402, 6.3730924382, 0.8468685728,
    1.9117111897, 6.4558954757, 0.5280745753, 1.9685511159, 6.5386985132,
    0.2669595137, 2.0012752311, 6.5920069620, 0.1283707758, 2.0117310703,
    6.6453154108, 0.0099476537, 2.0153444972, 6.6986238597, -0.0907061000,
    2.0131080707, 6.7519323085, -0.1760635671, 2.0059211527, 6.8052407573,
    -0.2486032450, 1.9945610015, 6.8585492062, -0.3105035539, 1.9796222983,
    6.9118576550, -0.3636631870, 1.9616093102, 6.9651661038, -0.4097383067,
    1.9409578621, 7.0300544039, -0.4583007660, 1.9127679150, 7.0949427039,
    -0.5005002465, 1.8816376896, 7.1598310040, -0.5379886694, 1.8479134315,
    7.2247193040, -0.5721156201, 1.8118727048, 7.3115083749, -0.6143540386,
    1.7603758705, 7.3982974458, -0.6544729749, 1.7053121189, 7.4850865167,
    -0.6940707099, 1.6467849997, 7.5718755876, -0.7344776065, 1.5847961587,
    7.7095690091, -0.8030284777, 1.4790144382, 7.8472624307, -0.8806254401,
    1.3632337799, 7.9849558522, -0.9717611419, 1.2358963056, 8.1226492737,
    -1.0816461261, 1.0947688983, 8.2450332654, -1.1998359150, 0.9554019290,
    8.3674172570, -1.3429684588, 0.8000775807, 8.4898012486, -1.5160613211,
    0.6254394132, 8.6121852403, -1.7228837542, 0.4276072962, 8.7345692319,
    -1.9626566912, 0.2027980260, 8.8569532236, -2.2261877861, -0.0536238705,
    8.9793372152, -2.4788550647, -0.3423111945, 9.1017212068, -2.6529231207,
    -0.6573854129, 9.2026425028, -2.6693991279, -0.9280312969, 9.3035637988,
    -2.5300266172, -1.1920065505, 9.4044850947, -2.2326536628, -1.4328632760,
    9.5054063907, -1.8071063485, -1.6372020847, 9.5890930179, -1.4087266727,
    -1.7714364885, 9.6727796452, -1.0204144347, -1.8727169390, 9.7564662724,
    -0.6710725759, -1.9434557589, 9.8401528997, -0.3790657874, -1.9872046812,
    9.9090428772, -0.1841735904, -2.0064486037, 9.9779328547, -0.0241599431,
    -2.0134840586, 10.0468228322, 0.1058297569, -2.0104686717, 10.1157128098,
    0.2108179130, -1.9993741940, 10.1737966174, 0.2837540164, -1.9849659217,
    10.2318804251, 0.3453692525, -1.9666555978, 10.2899642328, 0.3979047058,
    -1.9450178875, 10.3480480404, 0.4432693532, -1.9205451194, 10.4154398767,
    0.4890137547, -1.8891066343, 10.4828317129, 0.5292106712, -1.8547766880,
    10.5502235491, 0.5654341069, -1.8178637404, 10.6176153853, 0.5989636952,
    -1.7786074562, 10.7105012325, 0.6426140662, -1.7209392911, 10.8033870797,
    0.6851328538, -1.6592780221, 10.8962729268, 0.7282221715, -1.5936397346,
    10.9891587740, 0.7733435268, -1.5239165092, 11.1464444033, 0.8581177266,
    -1.3957595799, 11.3037300326, 0.9588318571, -1.2531430361, 11.4610156620,
    1.0829339372, -1.0929568775, 11.6183012913, 1.2396256166, -0.9107792410,
    11.7288351345, 1.3748194589, -0.7665351345, 11.8393689778, 1.5357143261,
    -0.6059071313, 11.9499028211, 1.7247638875, -0.4259389898, 12.0604366643,
    1.9409412503, -0.2236065144, 12.1709705076, 2.1772458625, 0.0036211412,
    12.2815043509, 2.4108082504, 0.2574672696, 12.3920381941, 2.5992312002,
    0.5352649307, 12.5025720374, 2.6801754730, 0.8283061567, 12.6060908405,
    2.5906931917, 1.1035825874, 12.7096096436, 2.3335062716, 1.3602721994,
    12.8131284468, 1.9417528265, 1.5817913824, 12.9166472499, 1.4648420244,
    1.7579301769, 13.0007811195, 1.0702541503, 1.8640275428, 13.0849149891,
    0.7146328822, 1.9386271485, 13.1690488587, 0.4142941139, 1.9859964360,
    13.2531827284, 0.1730964854, 2.0105064424, 13.3077431851, 0.0453019373,
    2.0163864909, 13.3623036419, -0.0630465418, 2.0158325676, 13.4168640986,
    -0.1546165466, 2.0098113095, 13.4714245554, -0.2320037426, 1.9991894475,
    13.5259850121, -0.2976909897, 1.9847019650, 13.5805454689, -0.3538045351,
    1.9668963181, 13.6351059256, -0.4021594850, 1.9462333483, 13.6896663824,
    -0.4443153535, 1.9231076713, 13.7578131676, -0.4902430370, 1.8912395435,
    13.8259599529, -0.5305531601, 1.8564374908, 13.8941067382, -0.5668611838,
    1.8190161123, 13.9622535235, -0.6004768377, 1.7792194646, 14.0551221138,
    -0.6438008495, 1.7214371351, 14.1479907042, -0.6860760268, 1.6596888451,
    14.2408592945, -0.7289817323, 1.5939842862, 14.3337278848, -0.7739631927,
    1.5242104254, 14.4917852202, -0.8590370763, 1.3953056657, 14.6498425556,
    -0.9603051180, 1.2518049698, 14.8078998911, -1.0853159531, 1.0905340897,
    14.9659572265, -1.2434194409, 0.9069815201, 15.0763725605, -1.3791144415,
    0.7624467943, 15.1867878944, -1.5405719648, 0.6014855439, 15.2972032284,
    -1.7301811888, 0.4211419367, 15.4076185624, -1.9467788404, 0.2184034680,
    15.5180338964, -2.1831682668, -0.0092362637, 15.6284492304, -2.4160255383,
    -0.2634316882, 15.7388645644, -2.6025931035, -0.5414146920, 15.8492798984,
    -2.6804613785, -0.8343569410, 15.9529745128, -2.5867253840, -1.1099176169,
    16.0566691272, -2.3249594429, -1.3663974470, 16.1603637416, -1.9297616828,
    -1.5872181273, 16.2640583561, -1.4512322300, -1.7623037065, 16.3484187617,
    -1.0564071172, -1.8675194945, 16.4327791674, -0.7017001859, -1.9411847783,
    16.5171395730, -0.4029832585, -1.9876555092, 16.6014999787, -0.1636096825,
    -2.0113535746, 16.6562349829, -0.0368568937, -2.0167622258, 16.7109699871,
    0.0705130220, -2.0157715946, 16.7657049914, 0.1611966786, -2.0093468391,
    16.8204399956, 0.2378037815, -1.9983524588, 16.8751749998, 0.3028194005,
    -1.9835200153, 16.9299100040, 0.3583660938, -1.9653926506, 16.9846450083,
    0.4062518022, -1.9444271835, 17.0393800125, 0.4480273774, -1.9210143555,
    17.1079029400, 0.4936887327, -1.8887255377, 17.1764258676, 0.5338176221,
    -1.8535019218, 17.2449487951, 0.5700250824, -1.8156542390, 17.3134717227,
    0.6036163963, -1.7754224428, 17.4070746249, 0.6471244837, -1.7168814726,
    17.5006775271, 0.6897136205, -1.6543200747, 17.5942804293, 0.7330765405,
    -1.5877354801, 17.6878833316, 0.7786767718, -1.5169991889, 17.8487210671,
    0.8661593806, -1.3848869861, 18.0095588027, 0.9709712381, -1.2374530943,
    18.1703965383, 1.1011885096, -1.0712384311, 18.3312342738, 1.2668603342,
    -0.8813288055, 18.4407148572, 1.4056548969, -0.7352881425, 18.5501954406,
    1.5704222961, -0.5725998313, 18.6596760240, 1.7631048613, -0.3903374980,
    18.7691566074, 1.9816523439, -0.1855920155, 18.8786371908, 2.2176501080,
    0.0439633552, 18.9881177742, 2.4451337926, 0.2995259628, 19.0975983576,
    2.6195633790, 0.5777263225, 19.2070789410, 2.6788378502, 0.8690994926,
    19.3120599482, 2.5596427760, 1.1466101623, 19.4170409553, 2.2706121532,
    1.4020112319, 19.5220219625, 1.8552605873, 1.6187520847, 19.6270029697,
    1.3677418031, 1.7875681111, 19.6982258258, 1.0366329429, 1.8729188982,
    19.7694486820, 0.7356644553, 1.9357782764, 19.8406715381, 0.4745997149,
    1.9787386000, 19.9118943942, 0.2562214487, 2.0045767506, 19.9339207957,
    0.1969186170, 2.0095604751, 19.9559471971, 0.1412867931, 2.0132786976,
    19.9779735986, 0.0891681562, 2.0158103910, 20.0000000000, 0.0403929477,
    2.0172311816,
};

// Number of 3-tuples in the test data.
static const size_t kVanDerPolTestDataCount = 237;

TEST_CASE("SharpFineRKNG8 with van der Pol second-order nonlinear ODE") {
    struct VanDerPolFunctor {
        double operator()(double x, double y, double yPrime) const {
            return ((1.0 - (y * y)) * yPrime) - y;
        }
    };

    VanDerPolFunctor f;

    double x = kVanDerPolTestData[0];
    double y = kVanDerPolTestData[1];
    double yPrime = kVanDerPolTestData[2];
    double h = kVanDerPolTestData[3] - x;
    double yNext, yPrimeNext, yHat, yHatPrime;

    for (auto i = 1; i < kVanDerPolTestDataCount - 1; ++i) {
        REQUIRE_GT(h, 0.0);

        egSC::SharpFineRKNG8<VanDerPolFunctor>(f, h, x, y, yPrime, yNext, yPrimeNext, yHat, yHatPrime);

        x = kVanDerPolTestData[i * 3];
        h = kVanDerPolTestData[(i + 1) * 3] - x;
        y = yNext;
        yPrime = yPrimeNext;

        // Check both y and y'.
        CHECK(y == doctest::Approx(kVanDerPolTestData[(i * 3) + 1]));
        CHECK(yPrime == doctest::Approx(kVanDerPolTestData[(i * 3) + 2]));
    }
}
