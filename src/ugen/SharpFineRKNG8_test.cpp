#include "SharpFineRKNG8.hpp"

#include "doctest/doctest.h"

#include <cstddef>
#include <cstdlib>

TEST_CASE("SharpFineRKNG8 simple first-order integration with closed form") {
    struct FirstOrderFunctor {
        double operator()(double x, double y, double yPrime) const {
            return 2.0;
        }
    };

    FirstOrderFunctor f;
    double h = 0.25;
    double x = 0.0;
    double y = 0.0;
    double yPrime = 0.0;
    double yNext, yPrimeNext, yHat, yHatPrime;

    for (auto i = 0; i < 2500; ++i) {
        egSC::SharpFineRKNG8<FirstOrderFunctor>(f, h, x, y, yPrime, yNext, yPrimeNext, yHat, yHatPrime);

        x += h;
        y = yNext;
        yPrime = yPrimeNext;

        CHECK(y == doctest::Approx(x * x));
        CHECK(yPrime == doctest::Approx(2.0 * x));
    }
}

// 3-tuples of data (x, y, y') of the van der Pol second-order nonlinear ODE
//  y'' - mu*(1 - y^2) * y' - y = 0
// With mu = 1 and initial conditions x = 0, y = 2, y' = 0 as computed by the MATLAB ode solver ode45 from the MATLAB
// documentation at https://www.mathworks.com/help/matlab/ref/ode45.html
static const double kVanDerPolTestData[] = {
    0.0000000000, 2.0000000000, 0.0000000000,
    0.0000251189, 1.9999999994, -0.0000502358,
    0.0000502377, 1.9999999975, -0.0001004679,
    0.0000753566, 1.9999999943, -0.0001506962,
    0.0001004755, 1.9999999899, -0.0002009206,
    0.0002260698, 1.9999999489, -0.0004519863,
    0.0003516641, 1.9999998764, -0.0007029573,
    0.0004772584, 1.9999997723, -0.0009538338,
    0.0006028527, 1.9999996368, -0.0012046158,
    0.0012308244, 1.9999984869, -0.0024571089,
    0.0018587960, 1.9999965513, -0.0037072437,
    0.0024867676, 1.9999938313, -0.0049550241,
    0.0031147392, 1.9999903286, -0.0062004542,
    0.0062545972, 1.9999611237, -0.0123924873,
    0.0093944553, 1.9999125681, -0.0185263558,
    0.0125343133, 1.9998448438, -0.0246025558,
    0.0156741713, 1.9997581309, -0.0306215837,
    0.0313734615, 1.9990459563, -0.0598765217,
    0.0470727517, 1.9978852116, -0.0877764945,
    0.0627720419, 1.9962966670, -0.1143828251,
    0.0784713321, 1.9943001777, -0.1397561358,
    0.1299531805, 1.9851264157, -0.2150479932,
    0.1814350289, 1.9723549870, -0.2797016078,
    0.2329168773, 1.9564779061, -0.3354833245,
    0.2843987256, 1.9379231097, -0.3839611232,
    0.3484736678, 1.9116185702, -0.4361486050,
    0.4125486101, 1.8822011010, -0.4812727116,
    0.4766235523, 1.8500538551, -0.5210801207,
    0.5406984945, 1.8154877047, -0.5570047752,
    0.6252200204, 1.7665619221, -0.6003802932,
    0.7097415464, 1.7140916661, -0.6410344377,
    0.7942630723, 1.6582260604, -0.6806061386,
    0.8787845983, 1.5990144513, -0.7204449518,
    1.0098885668, 1.5003553959, -0.7854067563,
    1.1409925352, 1.3927624700, -0.8574821540,
    1.2720965037, 1.2750455093, -0.9405609440,
    1.4032004722, 1.1454717525, -1.0389875516,
    1.5250199232, 1.0124429848, -1.1484684313,
    1.6468393743, 0.8647533411, -1.2804137734,
    1.7686588253, 0.6993591097, -1.4398520576,
    1.8904782763, 0.5126405495, -1.6313594455,
    2.0122977274, 0.3008802192, -1.8562889750,
    2.1341171784, 0.0592030866, -2.1119541731,
    2.2559366295, -0.2145300798, -2.3745096657,
    2.3777560805, -0.5175932884, -2.5907460373,
    2.4781898759, -0.7837801717, -2.6773808054,
    2.5786236712, -1.0514577692, -2.6258940721,
    2.6790574666, -1.3052066782, -2.4115902633,
    2.7794912619, -1.5300205675, -2.0456016461,
    2.8667416084, -1.6910980497, -1.6488306041,
    2.9539919549, -1.8166123325, -1.2340515978,
    3.0412423014, -1.9071736358, -0.8415451655,
    3.1284926479, -1.9657243236, -0.5055476121,
    3.1986968891, -1.9933286825, -0.2861737463,
    3.2689011303, -2.0068890078, -0.1048884336,
    3.3391053716, -2.0088555069, 0.0426199615,
    3.4093096128, -2.0014844867, 0.1614738999,
    3.4733998493, -1.9882430622, 0.2498499510,
    3.5374900859, -1.9698319210, 0.3230291545,
    3.6015803225, -1.9470881687, 0.3842037160,
    3.6656705590, -1.9207343882, 0.4360502585,
    3.7311249583, -1.8906752324, 0.4816866704,
    3.7965793576, -1.8578139021, 0.5218013797,
    3.8620337570, -1.8224516554, 0.5578964549,
    3.9274881563, -1.7848247853, 0.5912002775,
    4.0192073099, -1.7285834091, 0.6350190727,
    4.1109264635, -1.6683989331, 0.6773677896,
    4.2026456171, -1.6043169237, 0.7199609614,
    4.2943647707, -1.5362619532, 0.7642552225,
    4.4460951695, -1.4143155580, 0.8447462677,
    4.5978255684, -1.2792110136, 0.9391020780,
    4.7495559672, -1.1283381602, 1.0538548898,
    4.9012863660, -0.9579803411, 1.1969639108,
    5.0136026760, -0.8165085779, 1.3264645040,
    5.1259189859, -0.6590749105, 1.4811186601,
    5.2382352958, -0.4826916848, 1.6640903480,
    5.3505516057, -0.2841787420, 1.8758271244,
    5.4628679157, -0.0607124744, 2.1114239953,
    5.5751842256, 0.1902034845, 2.3528208719,
    5.6875005355, 0.4669960815, 2.5613704725,
    5.7998168454, 0.7622166235, 2.6753256677,
    5.9017342249, 1.0348829037, 2.6299757740,
    6.0036516043, 1.2940110288, 2.4210090473,
    6.1055689837, 1.5230365703, 2.0665606815,
    6.2074863632, 1.7104019008, 1.6085027292,
    6.2902894007, 1.8268109402, 1.2140537920,
    6.3730924382, 1.9117111897, 0.8468685728,
    6.4558954757, 1.9685511159, 0.5280745753,
    6.5386985132, 2.0012752311, 0.2669595137,
    6.5920069620, 2.0117310703, 0.1283707758,
    6.6453154108, 2.0153444972, 0.0099476537,
    6.6986238597, 2.0131080707, -0.0907061000,
    6.7519323085, 2.0059211527, -0.1760635671,
    6.8052407573, 1.9945610015, -0.2486032450,
    6.8585492062, 1.9796222983, -0.3105035539,
    6.9118576550, 1.9616093102, -0.3636631870,
    6.9651661038, 1.9409578621, -0.4097383067,
    7.0300544039, 1.9127679150, -0.4583007660,
    7.0949427039, 1.8816376896, -0.5005002465,
    7.1598310040, 1.8479134315, -0.5379886694,
    7.2247193040, 1.8118727048, -0.5721156201,
    7.3115083749, 1.7603758705, -0.6143540386,
    7.3982974458, 1.7053121189, -0.6544729749,
    7.4850865167, 1.6467849997, -0.6940707099,
    7.5718755876, 1.5847961587, -0.7344776065,
    7.7095690091, 1.4790144382, -0.8030284777,
    7.8472624307, 1.3632337799, -0.8806254401,
    7.9849558522, 1.2358963056, -0.9717611419,
    8.1226492737, 1.0947688983, -1.0816461261,
    8.2450332654, 0.9554019290, -1.1998359150,
    8.3674172570, 0.8000775807, -1.3429684588,
    8.4898012486, 0.6254394132, -1.5160613211,
    8.6121852403, 0.4276072962, -1.7228837542,
    8.7345692319, 0.2027980260, -1.9626566912,
    8.8569532236, -0.0536238705, -2.2261877861,
    8.9793372152, -0.3423111945, -2.4788550647,
    9.1017212068, -0.6573854129, -2.6529231207,
    9.2026425028, -0.9280312969, -2.6693991279,
    9.3035637988, -1.1920065505, -2.5300266172,
    9.4044850947, -1.4328632760, -2.2326536628,
    9.5054063907, -1.6372020847, -1.8071063485,
    9.5890930179, -1.7714364885, -1.4087266727,
    9.6727796452, -1.8727169390, -1.0204144347,
    9.7564662724, -1.9434557589, -0.6710725759,
    9.8401528997, -1.9872046812, -0.3790657874,
    9.9090428772, -2.0064486037, -0.1841735904,
    9.9779328547, -2.0134840586, -0.0241599431,
    10.0468228322, -2.0104686717, 0.1058297569,
    10.1157128098, -1.9993741940, 0.2108179130,
    10.1737966174, -1.9849659217, 0.2837540164,
    10.2318804251, -1.9666555978, 0.3453692525,
    10.2899642328, -1.9450178875, 0.3979047058,
    10.3480480404, -1.9205451194, 0.4432693532,
    10.4154398767, -1.8891066343, 0.4890137547,
    10.4828317129, -1.8547766880, 0.5292106712,
    10.5502235491, -1.8178637404, 0.5654341069,
    10.6176153853, -1.7786074562, 0.5989636952,
    10.7105012325, -1.7209392911, 0.6426140662,
    10.8033870797, -1.6592780221, 0.6851328538,
    10.8962729268, -1.5936397346, 0.7282221715,
    10.9891587740, -1.5239165092, 0.7733435268,
    11.1464444033, -1.3957595799, 0.8581177266,
    11.3037300326, -1.2531430361, 0.9588318571,
    11.4610156620, -1.0929568775, 1.0829339372,
    11.6183012913, -0.9107792410, 1.2396256166,
    11.7288351345, -0.7665351345, 1.3748194589,
    11.8393689778, -0.6059071313, 1.5357143261,
    11.9499028211, -0.4259389898, 1.7247638875,
    12.0604366643, -0.2236065144, 1.9409412503,
    12.1709705076, 0.0036211412, 2.1772458625,
    12.2815043509, 0.2574672696, 2.4108082504,
    12.3920381941, 0.5352649307, 2.5992312002,
    12.5025720374, 0.8283061567, 2.6801754730,
    12.6060908405, 1.1035825874, 2.5906931917,
    12.7096096436, 1.3602721994, 2.3335062716,
    12.8131284468, 1.5817913824, 1.9417528265,
    12.9166472499, 1.7579301769, 1.4648420244,
    13.0007811195, 1.8640275428, 1.0702541503,
    13.0849149891, 1.9386271485, 0.7146328822,
    13.1690488587, 1.9859964360, 0.4142941139,
    13.2531827284, 2.0105064424, 0.1730964854,
    13.3077431851, 2.0163864909, 0.0453019373,
    13.3623036419, 2.0158325676, -0.0630465418,
    13.4168640986, 2.0098113095, -0.1546165466,
    13.4714245554, 1.9991894475, -0.2320037426,
    13.5259850121, 1.9847019650, -0.2976909897,
    13.5805454689, 1.9668963181, -0.3538045351,
    13.6351059256, 1.9462333483, -0.4021594850,
    13.6896663824, 1.9231076713, -0.4443153535,
    13.7578131676, 1.8912395435, -0.4902430370,
    13.8259599529, 1.8564374908, -0.5305531601,
    13.8941067382, 1.8190161123, -0.5668611838,
    13.9622535235, 1.7792194646, -0.6004768377,
    14.0551221138, 1.7214371351, -0.6438008495,
    14.1479907042, 1.6596888451, -0.6860760268,
    14.2408592945, 1.5939842862, -0.7289817323,
    14.3337278848, 1.5242104254, -0.7739631927,
    14.4917852202, 1.3953056657, -0.8590370763,
    14.6498425556, 1.2518049698, -0.9603051180,
    14.8078998911, 1.0905340897, -1.0853159531,
    14.9659572265, 0.9069815201, -1.2434194409,
    15.0763725605, 0.7624467943, -1.3791144415,
    15.1867878944, 0.6014855439, -1.5405719648,
    15.2972032284, 0.4211419367, -1.7301811888,
    15.4076185624, 0.2184034680, -1.9467788404,
    15.5180338964, -0.0092362637, -2.1831682668,
    15.6284492304, -0.2634316882, -2.4160255383,
    15.7388645644, -0.5414146920, -2.6025931035,
    15.8492798984, -0.8343569410, -2.6804613785,
    15.9529745128, -1.1099176169, -2.5867253840,
    16.0566691272, -1.3663974470, -2.3249594429,
    16.1603637416, -1.5872181273, -1.9297616828,
    16.2640583561, -1.7623037065, -1.4512322300,
    16.3484187617, -1.8675194945, -1.0564071172,
    16.4327791674, -1.9411847783, -0.7017001859,
    16.5171395730, -1.9876555092, -0.4029832585,
    16.6014999787, -2.0113535746, -0.1636096825,
    16.6562349829, -2.0167622258, -0.0368568937,
    16.7109699871, -2.0157715946, 0.0705130220,
    16.7657049914, -2.0093468391, 0.1611966786,
    16.8204399956, -1.9983524588, 0.2378037815,
    16.8751749998, -1.9835200153, 0.3028194005,
    16.9299100040, -1.9653926506, 0.3583660938,
    16.9846450083, -1.9444271835, 0.4062518022,
    17.0393800125, -1.9210143555, 0.4480273774,
    17.1079029400, -1.8887255377, 0.4936887327,
    17.1764258676, -1.8535019218, 0.5338176221,
    17.2449487951, -1.8156542390, 0.5700250824,
    17.3134717227, -1.7754224428, 0.6036163963,
    17.4070746249, -1.7168814726, 0.6471244837,
    17.5006775271, -1.6543200747, 0.6897136205,
    17.5942804293, -1.5877354801, 0.7330765405,
    17.6878833316, -1.5169991889, 0.7786767718,
    17.8487210671, -1.3848869861, 0.8661593806,
    18.0095588027, -1.2374530943, 0.9709712381,
    18.1703965383, -1.0712384311, 1.1011885096,
    18.3312342738, -0.8813288055, 1.2668603342,
    18.4407148572, -0.7352881425, 1.4056548969,
    18.5501954406, -0.5725998313, 1.5704222961,
    18.6596760240, -0.3903374980, 1.7631048613,
    18.7691566074, -0.1855920155, 1.9816523439,
    18.8786371908, 0.0439633552, 2.2176501080,
    18.9881177742, 0.2995259628, 2.4451337926,
    19.0975983576, 0.5777263225, 2.6195633790,
    19.2070789410, 0.8690994926, 2.6788378502,
    19.3120599482, 1.1466101623, 2.5596427760,
    19.4170409553, 1.4020112319, 2.2706121532,
    19.5220219625, 1.6187520847, 1.8552605873,
    19.6270029697, 1.7875681111, 1.3677418031,
    19.6982258258, 1.8729188982, 1.0366329429,
    19.7694486820, 1.9357782764, 0.7356644553,
    19.8406715381, 1.9787386000, 0.4745997149,
    19.9118943942, 2.0045767506, 0.2562214487,
    19.9339207957, 2.0095604751, 0.1969186170,
    19.9559471971, 2.0132786976, 0.1412867931,
    19.9779735986, 2.0158103910, 0.0891681562,
    20.0000000000, 2.0172311816, 0.0403929477
};

// Number of 3-tuples in the test data.
static const size_t kVanDerPolTestDataCount = 237;

TEST_CASE("SharpFineRKNG8 with van der Pol second-order nonlinear ODE") {
    constexpr double maxStep = 1.0 / 250.0;

    struct VanDerPolFunctor {
        double operator()(double x, double y, double yPrime) const {
            return ((1.0 - (y * y)) * yPrime) - y;
        }
    };

    VanDerPolFunctor f;

    double x = kVanDerPolTestData[0];
    double y = kVanDerPolTestData[1];
    double yPrime = kVanDerPolTestData[2];
    double h = kVanDerPolTestData[3] - x;
    double yNext, yPrimeNext, yHat, yHatPrime;
        REQUIRE_GT(h, 0.0);

    for (auto i = 1; i < kVanDerPolTestDataCount - 1; ++i) {
        REQUIRE_GT(h, 0.0);

        while (h > maxStep) {
            egSC::SharpFineRKNG8<VanDerPolFunctor>(f, maxStep, x, y, yPrime, yNext, yPrimeNext, yHat, yHatPrime);
            h = h - maxStep;
            x = x + maxStep;
            y = yNext;
            yPrime = yPrimeNext;
        }

        egSC::SharpFineRKNG8<VanDerPolFunctor>(f, h, x, y, yPrime, yNext, yPrimeNext, yHat, yHatPrime);

        // Check both y and y'.
        CHECK(yNext == doctest::Approx(kVanDerPolTestData[(i * 3) + 1]).epsilon(0.01));
        CHECK(yPrimeNext == doctest::Approx(kVanDerPolTestData[(i * 3) + 2]).epsilon(0.01));

        x = kVanDerPolTestData[i * 3];
        h = kVanDerPolTestData[(i + 1) * 3] - x;

        y = kVanDerPolTestData[(i * 3) + 1];
        yPrime = kVanDerPolTestData[(i * 3) + 2];
    }
}
